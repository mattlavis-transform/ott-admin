{% extends "layout.html" %}

{% block pageTitle %}
    Quota {{ context.quota_order_number_id }}
{% endblock %}

{% block beforeContent %}
    {{ govukBackLink({
    text: "Back",
    href: "/quotas"
    }) }}
{% endblock %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-l">Quota {{ context.quota_order_number_id }} - quota definitions and balances</h1>
            <table class="govuk-table">
                <caption class="govuk-table__caption govuk-table__caption--m">Core quota data</caption>
                <tbody class="govuk-table__body">
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header">Quota order number</th>
                        <td class="govuk-table__cell">{{ context.quota_order_number_id }}</td>
                    </tr>
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header">Origin(s)</th>
                        <td class="govuk-table__cell">
                            <ul class="govuk-list govuk-!-margin-bottom-0">
                                {% for qono in context.quota_data.quota_order_number_origins %}
                                    <li>
                                        {{ qono.geographical_area_id }}
                                        ({{ qono.description }})
                                        from {{ qono.validity_start_date | format_date("D MMMM YYYY") }}
                                        {% if qono.validity_end_date %}
                                        to {{ qono.validity_end_date | format_date("D MMMM YYYY") }}
                                        {% endif %}
                                        </li>
                                {% endfor %}
                            </ul>

                        </td>
                    </tr>
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header">Quota dates</th>
                        <td class="govuk-table__cell">
                            From {{ context.quota_data.validity_start_date | format_date("D MMMM YYYY") }}
                            {% if context.quota_data.validity_end_date %}
                                to {{ context.quota_data.validity_end_date | format_date("D MMMM YYYY") }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header">Commodities and measures</th>
                        <td class="govuk-table__cell">
                            <a href="/quota_measures?quota_order_number_id={{ context.quota_order_number_id }}">Show commodities and measures for quota {{ context.quota_order_number_id }}</a>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h2 class="govuk-heading-m">Quota definition periods</h2>
            <p>This section lists all the quota definitions (aka accounts) for quota {{ context.quota_order_number_id }}.</p>

            <div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">
                {% set index = 0 %}
                {% for qd in context.quota_data.quota_definitions %}
                    <div class="govuk-accordion__section">
                        <div class="govuk-accordion__section-header">
                            <h2 class="govuk-accordion__section-heading">
                                <span class="govuk-accordion__section-button" id="accordion-default-heading-{{ index }}">
                                    Period: {{ qd.validity_start_date | format_date("D MMMM YYYY") }} to {{ qd.validity_end_date | format_date("D MMMM YYYY") }} - Definition {{ qd.quota_definition_sid }}
                                </span>
                            </h2>
                        </div>
                        <div id="accordion-default-content-{{ index }}" class="govuk-accordion__section-content" aria-labelledby="accordion-default-heading-{{ index }}">
                            {# Start core data  #}
                            <table class="govuk-table">
                                <caption class="govuk-table__caption govuk-table__caption--m">Core definition data</caption>
                                <tbody class="govuk-table__body">
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">Definition ID</th>
                                        <td class="govuk-table__cell">{{ qd.quota_definition_sid }}</td>
                                    </tr>
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">Start date</th>
                                        <td class="govuk-table__cell">{{ qd.validity_start_date | format_date("D MMMM YYYY") }}</td>
                                    </tr>
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">End date</th>
                                        <td class="govuk-table__cell">{{ qd.validity_end_date | format_date("D MMMM YYYY") }}</td>
                                    </tr>
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">Initial volume</th>
                                        <td class="govuk-table__cell">{{ qd.initial_volume | uk_numbers }}
                                            {{ qd.measurement_unit_code }}
                                            {{ qd.measurement_unit_qualifier_code }}</td>
                                    </tr>
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">Critical state</th>
                                        <td class="govuk-table__cell">{{ qd.critical_state }}</td>
                                    </tr>
                                    <tr class="govuk-table__row">
                                        <th scope="row" class="govuk-table__header">Critical threshold</th>
                                        <td class="govuk-table__cell">{{ qd.critical_threshold }}%</td>
                                    </tr>
                                </tbody>
                            </table>
                            {# End core data  #}

                            {# Start quota balance events  #}
                            <table class="govuk-table">
                                <caption class="govuk-table__caption govuk-table__caption--m">Quota balance events</caption>
                                <thead class="govuk-table__head">
                                    <tr class="govuk-table__row">
                                        <th scope="col" class="govuk-table__header">Event date</th>
                                        <th scope="col" class="govuk-table__header">Last import date</th>
                                        <th scope="col" class="govuk-table__header">Old balance ({{ qd.measurement_unit_code }})</th>
                                        <th scope="col" class="govuk-table__header">New balance ({{ qd.measurement_unit_code }})</th>
                                        <th scope="col" class="govuk-table__header">Imported amount ({{ qd.measurement_unit_code }})</th>
                                    </tr>
                                </thead>
                                <tbody class="govuk-table__body">
                                    {% for qbe in qd.quota_balance_events %}
                                        <tr class="govuk-table__row">
                                            <td class="govuk-table__cell">{{ qbe.occurrence_timestamp | format_date("D MMMM YYYY") }}</td>
                                            <td class="govuk-table__cell">{{ qbe.last_import_date_in_allocation | format_date("D MMMM YYYY") }}</td>
                                            <td class="govuk-table__cell">{{ qbe.old_balance | uk_numbers }}</td>
                                            <td class="govuk-table__cell">{{ qbe.new_balance | uk_numbers }}</td>
                                            <td class="govuk-table__cell">{{ qbe.imported_amount | uk_numbers }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <p>
                                <a href="/quota_graph?quota_order_number_id={{ context.quota_order_number_id }}&quota_definition_sid={{ qd.quota_definition_sid }}">See quota balance events on graph</a>
                            </p>
                            {# End quota balance events  #}

                            {# Start subsidiary events  #}
                            <h2 class="govuk-heading-m">Additional events</h2>
                            <p>The table below lists events of type critical, exhaustion, unblocking, unsuspension and re-opening.</p>
                            {% if qd.quota_subsidiary_events | length == 0 %}
                                <p>There are currently no events to display.</p>
                            {% else %}
                                <table class="govuk-table">
                                    {# <caption class="govuk-table__caption govuk-table__caption--m">Additional events</caption> #}
                                    <thead class="govuk-table__head">
                                        <tr class="govuk-table__row">
                                            <th scope="col" class="govuk-table__header">Event date</th>
                                            <th scope="col" class="govuk-table__header">Event type</th>
                                            <th scope="col" class="govuk-table__header">Updated state</th>
                                        </tr>
                                    </thead>
                                    <tbody class="govuk-table__body">
                                        {% for qse in qd.quota_subsidiary_events %}
                                            <tr class="govuk-table__row">
                                                <td class="govuk-table__cell">{{ qse.timestamp | format_date("D MMMM YYYY") }}</td>
                                                <td class="govuk-table__cell">{{ qse.event_type }}</td>
                                                <td class="govuk-table__cell">{{ qse.state }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                            {# End subsidiary events  #}

                        </div>
                    </div>
                {% endfor %}

            </div>
        </div>
    </div>
{% endblock %}